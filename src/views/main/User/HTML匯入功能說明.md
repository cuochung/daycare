# HTML 資料匯入功能使用說明

## 功能概述

本功能可將「照顧服務管理資訊平臺」匯出的 HTML 檔案解析並匯入到系統中，自動建立或更新住民資料。

## 使用步驟

### 1. 開啟匯入功能

1. 進入「病歷管理 & 維護」頁面
2. 點擊右上角的「匯入 HTML」按鈕（綠色按鈕）

### 2. 選擇檔案

1. 在對話框中點擊「選擇 HTML 檔案」
2. 可以一次選擇多個 HTML 檔案進行批次匯入
3. 系統會自動解析檔案內容
4. 解析完成後會顯示解析結果

### 3. 預覽資料

1. 點擊「下一步」進入預覽畫面
2. 檢視解析出的資料是否正確
3. 可點擊「眼睛」圖示查看詳細資料
4. 確認無誤後點擊「下一步」

### 4. 確認匯入

1. 系統會顯示即將匯入的資料筆數
2. 確認後點擊「開始匯入」
3. 等待匯入完成
4. 查看匯入結果報告

## 資料對應說明

### 基本資料

| HTML 欄位 | 系統欄位 | 說明 |
|----------|---------|------|
| 個案姓名 | name | 住民姓名 |
| 個案身分證 | id_num | 身分證字號（用於判斷重複） |
| 個案生日 | birthday | 民國年自動轉西元年 |
| 性別 | sex | 男/女 |
| 個案電話 | phone | 聯絡電話 |
| 戶籍地址 | registered_address | 戶籍地址 |
| 居住(通訊)地址 | living_address | 居住地址 |

### 聯絡人資料

- 主要聯絡人資料 → `contactMan[]`
- 代理人資料 → `contactMan[]`（標記為代理人）

### 照顧者資料

- 主要照顧者 → `primary_caregiver`
  - 姓名、身分證、性別、年齡、關係
- 次要照顧者 → `secondary_caregiver`
  - 姓名、身分證、性別、關係

### 評估資料

#### ADL 評估（日常生活活動能力）
- E1. 吃飯
- E2. 洗澡
- E3. 個人修飾
- E4. 穿脫衣物
- E5. 大便控制
- E6. 小便控制
- E7. 上廁所
- E8. 移位
- E9. 走路
- E10. 上下樓梯
- E11. 行動能力
- 總分自動計算

#### IADL 評估（工具性日常生活活動能力）
- F1. 使用電話
- F2. 購物
- F3. 備餐
- F4. 家務維持
- F5. 洗衣服
- F6. 使用交通工具
- F7. 服用藥物
- F8. 處理財務
- 總分自動計算

#### 溝通能力評估
- C1. 聽力
- C2. 視力
- C3. 表達能力
- C4. 理解能力

#### 認知功能評估
- D1. 短期記憶
- D2. 長期記憶
- D3. 定向感
- D4. 計算能力
- D5. 判斷能力

### 福利資料

- 長照福利身份 → `welfare_status`
- 重大傷病證明 → `Welfare.MajorIllnessCert`
- 身心障礙證明 → `Welfare.DisabilityCert`

### 其他資料

- 常用語言 → `languages[]`（多選）
- 婚姻狀況 → `marriage_status`
- 教育程度 → `education`
- 原住民身分 → `indigenous`
- 居住狀況 → `living_status`
- 就業狀況 → `employment`

## 重複處理機制

### 判斷標準
系統以「身分證字號」作為唯一識別碼。

### 處理方式
- **已存在**：更新原有資料，保留原病歷號、建立資訊、圖片等
- **不存在**：新增資料，自動生成病歷號

### 更新記錄
- 每次更新都會在 `editInfo` 中新增記錄
- 記錄包含：操作人、時間、備註（標記為「從 HTML 匯入更新」）

## 注意事項

### 1. 檔案格式
- 僅支援從「照顧服務管理資訊平臺」匯出的 HTML 檔案
- 檔案副檔名必須為 `.html` 或 `.htm`

### 2. 必填欄位
- 個案姓名（name）
- 個案身分證（id_num）

### 3. 日期格式
- 民國年格式（如 036/03/20）會自動轉換為西元年（1947-03-20）
- 轉換公式：西元年 = 民國年 + 1911

### 4. 資料限制
- 圖片資料無法從 HTML 匯入，需手動上傳
- 部分欄位若 HTML 中不存在，會填入空值或預設值

### 5. 批次匯入
- 支援一次匯入多個檔案
- 顯示即時進度
- 匯入完成後會顯示成功/失敗統計

## 匯入結果

### 成功
- 顯示成功匯入筆數
- 顯示更新筆數（若有重複資料）
- 自動重新載入住民列表

### 失敗
- 顯示失敗筆數
- 列出失敗原因
- 可重新嘗試匯入

## 資料驗證

### 自動驗證項目
1. 姓名不可為空
2. 身分證字號不可為空
3. 身分證字號格式（10碼）
4. 日期格式正確性

### 驗證失敗處理
- 該筆資料標記為「錯誤」
- 在預覽畫面中以紅色標示
- 不會被匯入到系統中

## 技術細節

### 解析方式
- 使用 DOMParser 解析 HTML
- 從 `<table class="table-bordered">` 中提取資料
- 透過 `<th>` 和 `<td>` 配對取得欄位值

### 資料儲存
- 所有資料以 JSON 格式儲存在 `datalist` 欄位
- 保留原始資料結構
- 新增 `imported_from_html` 標記
- 記錄匯入時間 `import_date`

### 擴充性
- 新增 `raw_data` 欄位儲存原始解析資料
- 可隨時擴充新欄位而不影響現有資料
- 支援未來新增更多評估量表

## 常見問題

### Q1: 匯入後找不到資料？
A: 請檢查是否有設定「隱藏」篩選條件，匯入的資料預設為顯示狀態。

### Q2: 為什麼有些欄位是空的？
A: 可能是 HTML 檔案中該欄位沒有資料，或該欄位在照服平台中未填寫。

### Q3: 可以重複匯入同一個檔案嗎？
A: 可以，系統會以身分證字號判斷，若已存在則更新資料。

### Q4: 匯入後可以修改資料嗎？
A: 可以，匯入後的資料與手動新增的資料完全相同，可以正常編輯。

### Q5: 如何確認資料是從 HTML 匯入的？
A: 可以在編輯畫面的 `editInfo` 中查看操作記錄，會標記「從 HTML 匯入更新」。

## 更新記錄

- 2024-12-15: 初版完成
  - 支援基本資料匯入
  - 支援聯絡人資料匯入
  - 支援照顧者資料匯入
  - 支援 ADL/IADL 評估資料匯入
  - 支援溝通能力與認知功能評估
  - 支援批次匯入
  - 支援重複資料更新

