---
name: 排班條件未完成項目清單
overview: 依據「排班條件實作計畫」與現有程式碼比對，條列出本案子尚未完成的內容。4.1 病歷管理擴充（優先項目）已有 ResidentScheduleDialog 與 API 對接；其餘 4.2～4.5 皆為備用、尚未實作。
todos: []
isProject: false
---

# 排班條件實作計畫 — 未完成項目清單

## 已實作概況

4.1 病歷管理擴充（優先項目）大部分已完成：

- [ResidentScheduleDialog.vue](src/components/ResidentScheduleDialog.vue)：開始日期（存 user.datalist）、每週使用日、schedule_type、quota_type、day_type、resident_schedule CRUD
- [careFeeOptions.js](src/assets/js/careFeeOptions.js)：收費表組合（B/G/SC）
- [documents/resident_schedule_table_schema.md](documents/resident_schedule_table_schema.md)：後端表結構說明
- User 病歷管理已整合排班設定入口

---

## 一、4.2 出席一覽 — 月曆與資料取得規格補充

### 月曆 UI

- **快速切換**：可快速切上個月、下個月
- 切換月份時重新取得該月 `resident_schedule` 資料

### resident_schedule 依月份取得

- **依每個月去取得**：切換月份時，只取得該月適用之 resident_schedule
- **可排住民邏輯**：取得 `start_date <= 當月最後一天` 的記錄，再依 `weekdays` 判斷該日是否可排

### 後端 API — 使用 byjson

- **位置**：daycareapi `app/Controllers/Byjson.php`
- **適用方法**：`getZoneData`（區間查詢）
- **URL**：`POST byjson/getZoneData/{databaseName}/{sheetName}`
- **POST 參數**：
  - `key`：datalist 中的日期欄位名稱（如 `start_date`）
  - `start`：區間起日（YYYY-MM-DD）
  - `end`：區間迄日（YYYY-MM-DD）
- **範例**：取得 2026 年 2 月可排住民
  ```
  POST byjson/getZoneData/daycare/resident_schedule
  Body: { key: 'start_date', start: '2000-01-01', end: '2026-02-29' }
  ```
  （`start` 設較早日期可涵蓋「已在當月前就開始」的住民；`end` 為當月最後一天）

### Byjson 其他可用方法（供參考）


| 方法                      | 用途                                     |
| ----------------------- | -------------------------------------- |
| searchDataInclude       | 搜尋 datalist 包含指定 key 的記錄               |
| searchDataAndDate       | 日期區間 + searchKey（需 dateKey 對應表）        |
| searchByKeyValue        | key = value 精準搜尋                       |
| searchIncludeByKeyValue | key like value 模糊搜尋                    |
| getZoneData             | 依 key 的日期欄位做區間查詢（適用 resident_schedule） |


### 前端呼叫方式

- 使用 `api.options()` 自訂 URL，例如：
  ```js
  await api.options('byjson/getZoneData/daycare/resident_schedule', {
    key: 'start_date',
    start: firstDayOfMonth,  // 或 '2000-01-01' 涵蓋更早開始者
    end: lastDayOfMonth
  })
  ```

---

## 二、4.2 出席一覽（月曆模式）— 備用，全部未實作


| 項目     | 說明                                                                                                                                                             |
| ------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 路由與選單  | 未新增 `/main/AttendanceCalendar` 或 `/main/AttendanceList`；[router/index.js](src/router/index.js) 和 [useStore.js](src/stores/useStore.js) 的 authKeys 未加入「出席一覽」入口。 |
| 月曆檢視   | 月曆顯示當月、每個日期格子顯示「上午人數」、「下午人數」、「有到人數」；具備快速切上個月／下個月按鈕；切換月份時以 byjson/getZoneData 依該月取得 resident_schedule— 未實作。                                                     |
| 當日詳情   | 點選日期進入當日詳情，顯示當日上課名單（上午/下午、全日/半日），並可輸入出席、到機構時間、生命徵象（體溫、脈搏、血壓、血氧、呼吸）、用藥、進食— 未實作。                                                                                 |
| 月曆操作選單 | 調整住民開始上課日、依當月符合住民排課、單排指定住民— 未實作。                                                                                                                               |
| 移動至他日  | 在當日名單中將指定住民從 A 日改排到 B 日，並檢查 B 日該時段是否未滿 28 人— 未實作。                                                                                                              |


---

## 三、4.3 容量與收費規則 — 備用，全部未實作


| 項目          | 說明                                                                                            |
| ----------- | --------------------------------------------------------------------------------------------- |
| 上午/下午各 28 人 | 排班與移動時檢查該日該時段已排人數，超過 28 人不允許新增或移入— 未實作。                                                       |
| 收費表組合驗證     | 排班所選照顧組合需對應 [documents/照顧組合收費.md](documents/照顧組合收費.md)，數量與計價僅採這些代碼— 前端選項已限制，後端/排班邏輯是否完整驗證待確認。 |
| 組數當月用完      | 計算每位住民當月已使用組數，排班或移動時不超過當月配額— 未實作。                                                             |


---

## 四、4.4 與既有模組銜接 — 備用，未實作


| 項目            | 說明                                                                                             |
| ------------- | ---------------------------------------------------------------------------------------------- |
| 排班/出席表與當日狀態紀錄 | 需有排班表（日期 + 上午/下午 + user_snkey + 服務型態 + 照顧組合代碼）及當日狀態紀錄（出席、到機構時間、生命徵象、用藥、進食）— 表結構與 API 未實作。      |
| 生命徵象          | 計畫要求僅存於當日紀錄表，與 SignLifeMulti 無需關聯— 尚無當日紀錄表，故未實作。                                               |
| 會計結算銜接        | 排班結果應作為「每日班別」產出，與 [客戶需求理解：資料匯入至會計結算](.cursor/plans/客戶需求理解：資料匯入至會計結算_d70ed251.plan.md) 對接— 未實作。 |


---

## 五、4.5 車趟 BB08 — 暫不執行


| 項目   | 說明                              |
| ---- | ------------------------------- |
| 車趟資訊 | 預留「車趟」欄位或表，記錄 BB08 當月使用次數— 未實作。 |
| 車趟介面 | 在出席一覽或住民排班設定中可查詢/輸入車趟次數— 未實作。   |


---

## 六、實作順序摘要（依計畫第五節）

**本階段優先**：4.1 病歷管理擴充 — 主要功能已完成，僅剩後端表與 API 是否上線需確認。

**待 4.1 完成後再進行**：

1. 排班/出席表與當日狀態紀錄
2. 出席一覽月曆
3. 當日詳情
4. 排班操作（依當月排課、單排指定住民）
5. 移動至他日
6. 容量與組數檢查
7. 會計銜接
8. 車趟 BB08

